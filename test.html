<script>
  (function () {
    var audio = document.getElementById('audio');
    var capture = document.getElementById('capture');

    // 재생은 1회만. 진행 중/시도 중에는 추가 입력이 와도 절대 0초로 되감기지 않게 잠금.
    var hasStarted = false;   // 한번이라도 재생이 실제로 시작되면 true
    var finished = false;     // 끝까지 재생되면 true
    var inFlight = false;     // play() 시도 중(결과 대기 중)인 동안 true
    var lastAttemptAt = 0;

    function canAttemptNow() {
      var now = Date.now();
      if (now - lastAttemptAt < 300) return false;
      lastAttemptAt = now;
      return true;
    }

    function stopRetry(timerId) {
      try { clearInterval(timerId); } catch (e) {}
    }

    function startOnce() {
      if (finished || hasStarted || inFlight) return;
      if (!canAttemptNow()) return;

      inFlight = true;

      if (capture && capture.parentNode) {
        capture.parentNode.removeChild(capture);
        capture = null;
      }

      // 오직 "처음 시도"에서만 0초로 맞춤
      try { audio.currentTime = 0; } catch (e) {}
      try { audio.muted = false; } catch (e) {}

      var p;
      try {
        p = audio.play();
      } catch (e) {
        inFlight = false;
        return;
      }

      if (p && typeof p.then === 'function') {
        p.then(function () {
        }).catch(function () {
          // 실패하면 다음 입력에서 다시 시도할 수 있게만 풀어줌
          inFlight = false;
        });
      } else {
        inFlight = false;
      }
    }

    function onWheel(e) {
      if (e && typeof e.deltaY === 'number' && e.deltaY > 0) startOnce();
    }
    function onKeydown() { startOnce(); }
    function onPointerDown() { startOnce(); }
    function onTouchStart() { startOnce(); }

    // 5초 후 자동 시도(정책상 막힐 수 있음). 성공해도 1회.
    setTimeout(function () {
      startOnce();
    }, 5000);

    // 조용한 재시도(1초 간격). 재생 시작되면 즉시 중단.
    var retryTimer = setInterval(function () {
      if (finished || hasStarted) {
        stopRetry(retryTimer);
        return;
      }
      startOnce();
    }, 1000);

    audio.addEventListener('playing', function () {
      hasStarted = true;
      inFlight = false;
      stopRetry(retryTimer);
    });

    audio.addEventListener('ended', function () {
      finished = true;
      inFlight = false;
      stopRetry(retryTimer);
    });

    audio.addEventListener('pause', function () {
      // 시작 이후에는 재시작하지 않음
      if (hasStarted) inFlight = false;
    });

    if (capture) {
      capture.addEventListener('wheel', onWheel, { passive: true });
      capture.addEventListener('keydown', onKeydown, { passive: true });
      capture.addEventListener('pointerdown', onPointerDown, { passive: true });
      capture.addEventListener('touchstart', onTouchStart, { passive: true });
    }

    window.addEventListener('wheel', onWheel, { passive: true });
    window.addEventListener('keydown', onKeydown, { passive: true });
    window.addEventListener('pointerdown', onPointerDown, { passive: true });
    window.addEventListener('touchstart', onTouchStart, { passive: true });

    try {
      if (capture) capture.focus({ preventScroll: true });
    } catch (e) {
      try { if (capture) capture.focus(); } catch (e2) {}
    }
  })();
</script>
